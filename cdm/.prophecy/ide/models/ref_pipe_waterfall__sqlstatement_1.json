{
  "id" : "ref_pipe_waterfall__sqlstatement_1",
  "metainfo" : {
    "label" : "ref_pipe_waterfall__sqlstatement_1",
    "autoLayout" : true,
    "staleState" : "none",
    "sourceSuggestions" : {
      "sources" : [ ]
    },
    "graphConfig" : {
      "entityConfig" : {
        "materialized" : "ephemeral",
        "database" : "\"tanmay\"",
        "schema" : "\"default2\"",
        "type" : "ModelConfig"
      }
    },
    "version" : 3
  },
  "processes" : {
    "sqlstatement_1_0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR" : {
      "id" : "sqlstatement_1_0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR",
      "component" : "TargetModel",
      "metadata" : {
        "label" : "sqlstatement_1"
      },
      "properties" : {
        "customQueryDisabled" : true,
        "customQuery" : false,
        "incrementalEditorDisabled" : true,
        "query" : "\nSELECT *\n\nFROM sqlstatement_1\n\n",
        "isModel" : true,
        "incrementalKey" : false,
        "incremental" : {
          "expression" : "true"
        }
      },
      "ports" : {
        "inputs" : [ {
          "id" : "input_port_0",
          "slug" : "input_port_0"
        } ],
        "outputs" : [ {
          "id" : "output_port_0",
          "slug" : "output_port_0",
          "dataExplorerProps" : {
            "sorts" : [ {
              "exp" : {
                "type" : "Field",
                "value" : "Credit Line Usage Ratio"
              },
              "type" : "Simple",
              "order" : {
                "type" : "Desc"
              }
            } ],
            "filter" : {
              "type" : "Composite",
              "op" : {
                "type" : "AND"
              },
              "filters" : [ ]
            }
          }
        } ],
        "isCustomOutputSchema" : false,
        "autoUpdateOnRun" : false
      }
    },
    "BHwkH_fHM8TOQw67WLFow$$a6-WJuctRaPS6Ugje5UvQ" : {
      "id" : "BHwkH_fHM8TOQw67WLFow$$a6-WJuctRaPS6Ugje5UvQ",
      "component" : "SQLStatement",
      "metadata" : {
        "label" : "sqlstatement_1",
        "x" : -120,
        "y" : -200,
        "phase" : 0
      },
      "properties" : {
        "fileTabs" : [ {
          "path" : "out",
          "id" : "out",
          "language" : "sql",
          "content" : "-- Databricks SQL version\nWITH CTE_Level_0 AS (\n  SELECT\n    `4506-T Indicator`                                           AS `4506T Flag`,\n    `Supplemental Field: COVID FB End Dt`                        AS `AM: Plan End Date`,\n    `Supplemental Field: COVID FB Start Dt`                      AS `AM: Plan Start Date`,\n    `Interest Type Indicator`                                    AS `ARM Flag`,\n    `Index Type`                                                 AS `ARM Index`,\n    `Initial Fixed Rate Period`                                  AS `ARM Initial Fixed Rate Period`,\n    `Initial Interest Rate Cap (Change Up)`                      AS `ARM Initial Rate Adj Cap`,\n    `ARM Look-back Days`                                         AS `ARM Lookback Days`,\n    `Gross Margin`                                               AS `ARM Margin`,\n    `Lifetime Maximum Rate (Ceiling)`                            AS `ARM Max Rate`,\n    `Lifetime Minimum Rate (Floor)`                              AS `ARM Min Rate`,\n    `Subsequent Payment Reset Period`                            AS `ARM Payment Adj Frequency`,\n    `Subsequent Interest Rate Cap (Change Up)`                   AS `ARM Periodic Cap`,\n    `Subsequent Interest Rate Reset Period`                      AS `ARM Rate Adj Frequency`,\n    `ARM Round Factor`                                           AS `ARM Round Factor`,\n    `ARM Round Flag`                                             AS `ARM Round Flag`,\n    `As of Date`                                                 AS `Acq Cutoff Date`,\n    `Supplemental Field: COVID FB Active Flag`                   AS `Active Forbearance Flag`,\n    `Supplemental Field: Initial HELOC Draw Amount`              AS `Amount First Disbursement`,\n    `As of Date`                                                 AS `As Of Date`,\n    `Borrower Asset Verification`                                AS `Borr 1 Asset Verification`,\n    `Most Recent Primary Borrower FICO`                          AS `Borr 1 Credit Score`,\n    `Most Recent FICO Date`                                      AS `Borr 1 Credit Score Date`,\n    `Borrower Employment Verification`                           AS `Borr 1 Employment Verification`,\n    `Borrower Income Verification Level`                         AS `Borr 1 Income Verification`,\n    `Length of Employment: Borrower`                             AS `Borr 1 Length of Employment`,\n    `Primary Borrower Other Income`                              AS `Borr 1 Other Income`,\n    `Self-employment Flag`                                       AS `Borr 1 Self-Employment Flag`,\n    `Primary Borrower Wage Income`                               AS `Borr 1 Wage Income`,\n    `Co-Borrower Asset Verification`                             AS `Borr 2 Asset Verification`,\n    `Most Recent Co-Borrower FICO`                               AS `Borr 2 Credit Score`,\n    `Co-Borrower Employment Verification`                        AS `Borr 2 Employment Verification`,\n    `Co-Borrower Income Verification`                            AS `Borr 2 Income Verification`,\n    `Length of Employment: Co-Borrower`                          AS `Borr 2 Length of Employment`,\n    `Co-Borrower Other Income`                                   AS `Borr 2 Other Income`,\n    `Co-Borrower Wage Income`                                    AS `Borr 2 Wage Income`,\n    `Primary Borrower ID`                                        AS `BorrowerID`,\n    `Broker Indicator`                                           AS `Broker Flag`,\n    `Buy Down Period`                                            AS `Buydown Period`,\n    `Cash Out Amount`                                            AS `Cash Out Amount`,\n    `MI Certificate Number`                                      AS `Claim Certificate Number`,\n    `Supplemental Field: Existing Corporate Advance`             AS `Corp Advance Recoverable Balance`,\n    `Credit Line Usage Ratio`                                    AS `Credit Line Usage Ratio`,\n    `Credit Report: Longest Trade Line`                          AS `Credit: Longest Trade Line`,\n    `Credit Report: Maximum Trade Line`                          AS `Credit: Maximum Trade Line`,\n    `Credit Report: Number of Trade Lines`                       AS `Credit: Number of Trade Lines`,\n    `Total Deferred Amount`                                      AS `Curr Deferred Balance`,\n    `Current Loan Amount`                                        AS `Curr Loan Balance`,\n    `Current Interest Rate`                                      AS `Curr Loan Interest Rate`,\n    `Maturity Date`                                              AS `Curr Loan Maturity Date`,\n    `Current Payment Amount Due`                                 AS `Curr PI Payment`,\n    `Paid Through Date`                                          AS `Curr Payment Paid Thru Date`,\n    `Current Payment Status`                                     AS `Curr Servicer Delinquency Status`,\n    `Junior Mortgage Balance`                                    AS `Current Junior Mortgage Balance`,\n    `Current 'Other' Monthly Payment`                            AS `Current Other Payment`,\n    `Current Payment Amount Due`                                 AS `Current Payment Amount Due`,\n    `Supplemental Field: TILA Status`                            AS `DD: TIL Status`,\n    `Originator DTI`                                             AS `DTI Ratio`,\n    `Updated DTI (Front-end)`                                    AS `DTI Ratio (Front-End)`,\n    `Supplemental Field: Documentation Type`                     AS `Doc Type`,\n    `Supplemental Field: Existing Escrow Advance`                AS `Escrow Advance Balance`,\n    `Escrow Indicator`                                           AS `Escrow Flag`,\n    `Covered/High Cost Loan Indicator`                           AS `High Cost Flag`,\n    `Initial Fixed Payment Period`                               AS `Init Fixed Payment Period`,\n    `Initial Minimum Payment`                                    AS `Init Min Payment`,\n    `Initial Negative Amortization Recast Period`                AS `Init NegAm Recast Period`,\n    `Initial Interest Rate Cap (Change Down)`                    AS `Init Periodic Cap (Down)`,\n    `Initial Periodic Payment Cap`                               AS `Init Periodic Pay Cap`,\n    `HELOC Draw Period`                                          AS `LOC Draw Period`,\n    `Supplemental Field: HELOC Status`                           AS `LOC Line Status`,\n    `Original Loan Amount`                                       AS `LOC Max Original Credit Line`,\n    `Lien Position`                                              AS `Lien Position`,\n    `Heloc Indicator`                                            AS `Line of Credit Flag`,\n    `Liquid / Cash Reserves`                                     AS `Liquid / Cash Reserves`,\n    `Origination Date`                                           AS `Loan Funding Date`,\n    `Loan Purpose`                                               AS `Loan Purpose`,\n    `MI Certificate Number`                                      AS `MI Cert Num`,\n    `Mortgage Insurance Company Name`                            AS `MI Company`,\n    `Mortgage Insurance Percent`                                 AS `MI Coverage Pct`,\n    `MI: Lender or Borrower Paid?`                               AS `MI Type`,\n    `Total Capitalized Amount`                                   AS `Mod Capitalized Amount`,\n    `Forgiven Interest Amount`                                   AS `Mod Forgiven Interest Amount`,\n    `Forgiven Principal Amount`                                  AS `Mod Forgiven Principal Amount`,\n    `Supplemental Field: Step Rate 1`                            AS `Mod Step Rate 1`,\n    `Supplemental Field: Step Date 1`                            AS `Mod Step Start 1`,\n    `Modification Effective Payment Date`                        AS `Modification Date`,\n    `Supplemental Field: Mod_flag`                               AS `Modification Flag`,\n    `Monthly Debt All Borrowers`                                 AS `Monthly Debt All Borrowers`,\n    `Months Bankruptcy`                                          AS `Months Since BK Discharge`,\n    `Months Foreclosure`                                         AS `Months Since FC Sale`,\n    `Number of Mortgaged Properties`                             AS `Multiple Properties Flag`,\n    `Negative Amortization Limit`                                AS `NegAm Limit`,\n    `Number of Mortgaged Properties`                             AS `Number Of Properties`,\n    `Total Number of Borrowers`                                  AS `Number of Borrowers`,\n    `Number of Modifications`                                    AS `Number of Modifications`,\n    `Option ARM Indicator`                                       AS `OptionARM Flag`,\n    `Original Amortization Term`                                 AS `Orig Amortization Term`,\n    `Amortization Type`                                          AS `Orig Amortization Type`,\n    `Original Property Valuation Date`                           AS `Orig Appraisal Date`,\n    `Original Appraised Property Value`                          AS `Orig Appraisal Value`,\n    `Original CLTV`                                              AS `Orig CLTV`,\n    `Channel`                                                    AS `Orig Channel`,\n    `First Payment Date of Loan`                                 AS `Orig First Payment Date`,\n    `Original Interest Only Term`                                AS `Orig Interest Only Term`,\n    `Junior Mortgage Balance`                                    AS `Orig Junior Loan Amount`,\n    `Original LTV`                                               AS `Orig LTV`,\n    `Original Loan Amount`                                       AS `Orig Loan Amount`,\n    `Original Interest Rate`                                     AS `Orig Loan Interest Rate`,\n    `Original Term to Maturity`                                  AS `Orig Loan Term`,\n    `Occupancy`                                                  AS `Orig Occupancy Status`,\n    `Original Pledged Assets`                                    AS `Orig Pledged Assets`,\n    `Sales Price`                                                AS `Orig Sales Price`,\n    `Supplemental Field: Original Qualifying FICO`               AS `Original FICO`,\n    `Total Origination and Discount Points (in dollars)`         AS `Origination Discount Points ($)`,\n    `Origination Date`                                           AS `Origination Note Date`,\n    `Loan Number`                                                AS `Originator Loan ID`,\n    `Originator`                                                 AS `Originator Name`,\n    `Most Recent 24-month Pay History`                           AS `Pay History 24 Mths`,\n    `Current Payment Status`                                     AS `Performance Status`,\n    `Loan Group`                                                 AS `Pool`,\n    `Pool Insurance Co. Name`                                    AS `Pool Ins Company`,\n    `Pool Insurance Stop Loss %`                                 AS `Pool Ins Stop Loss %`,\n    `Pre-Modification Initial Interest Rate Change Downward Cap` AS `Pre-Mod Init Periodic Cap`,\n    `Pre-Modification I/O Term`                                  AS `Pre-Mod Interest Only Term`,\n    `Pre-Modification Interest (Note) Rate`                      AS `Pre-Mod Interest Rate`,\n    `Pre-Modification Next Interest Rate Change Date`            AS `Pre-Mod Next Rate Adj Date`,\n    `Pre-Modification P&I Payment`                               AS `Pre-Mod PI Payment`,\n    `Pre-Modification Subsequent Interest Rate Cap`              AS `Pre-Mod Subseq Periodic Cap`,\n    `Prepayment Penalty Calculation`                             AS `Prepayment Penalty Description`,\n    `Prepayment Penalty Hard Term`                               AS `Prepayment Penalty Hard Term`,\n    `Prepayment Penalty Total Term`                              AS `Prepayment Penalty Period`,\n    `City`                                                       AS `Property City`,\n    `Supplemental Field: Collateral Type`                        AS `Property Description`,\n    `Most Recent Property Value`                                 AS `Property Latest Value ($)`,\n    `Most Recent Property Valuation Date`                        AS `Property Latest Value Date`,\n    `Most Recent Property Valuation Type`                        AS `Property Latest Value Method`,\n    `Most Recent AVM Model Name`                                 AS `Property Latest Value Source`,\n    `State`                                                      AS `Property State`,\n    `Property Type`                                              AS `Property Type`,\n    `Postal Code`                                                AS `Property Zip`,\n    `Qualification Method`                                       AS `Qualification Method`,\n    `Relocation Loan Indicator`                                  AS `Relocation Flag`,\n    `Self-employment Flag`                                       AS `Self-Employment Flag`,\n    `Supplemental Field: Seller`                                 AS `Seller`,\n    `Senior Loan Amount(s)`                                      AS `Senior Lien Current Balance`,\n    `Hybrid Period of Most Senior Lien (in months)`              AS `Senior Lien Hybrid Period`,\n    `Supplemental Field: Senior Lien Note Rate`                  AS `Senior Lien Loan Interest Rate`,\n    `Loan Type of Most Senior Lien`                              AS `Senior Lien Loan Type`,\n    `Neg Am Limit of Most Senior Lien`                           AS `Senior Lien Neg Am Limit`,\n    `Origination Date of Most Senior Lien`                       AS `Senior Lien Origination Note Date`,\n    `Primary Servicer`                                           AS `Servicer Name`,\n    `Subsequent Negative Amortization Recast Period`             AS `Subseq NegAm Recast Period`,\n    `Subsequent Interest Rate (Change Down)`                     AS `Subseq Periodic Cap (Down)`,\n    `Subsequent Periodic Payment Cap`                            AS `Subseq Periodic Pay Cap`,\n    `Servicing Advance Methodology`                              AS `Svc Advance Method`,\n    `Servicing Fee-Flat Dollar`                                  AS `Svc Fee Amt ($)`,\n    `Servicing Fee-Percentage`                                   AS `Svc Fee Rate (%)`,\n    `All Borrower Total Income`                                  AS `Total Combined Monthly Income`,\n    `All Borrower Wage Income`                                   AS `Total Combined Wage Income`,\n    `Years in Home`                                              AS `Years in Home`\n  FROM `gsmbs_raw_source`\n),\n\nCTE_Level_1 AS (\n  SELECT\n    *,\n    -- If ARM Flag = 0 => NULL else add months (using ARM Initial Fixed Rate Period or ARM Rate Adj Frequency)\n    CASE WHEN `ARM Flag` = 0 THEN NULL\n         ELSE add_months(to_date(`Orig First Payment Date`),\n                         COALESCE(CAST(`ARM Initial Fixed Rate Period` AS INT),\n                                  CAST(`ARM Rate Adj Frequency` AS INT)))\n    END AS `ARM First Rate Adj Date`,\n\n    -- Current available LOC\n    `LOC Max Original Credit Line` - `Curr Loan Balance` AS `Curr Available Line of Credit`,\n\n    -- Current CLTV (calc) with nullif for divide-by-zero safety\n    (COALESCE(`Curr Loan Balance`, 0) + COALESCE(`Senior Lien Current Balance`, 0) + COALESCE(`Current Junior Mortgage Balance`, 0))\n      / NULLIF(`Property Latest Value ($)`, 0) AS `Curr CLTV (Calc)`,\n\n    CASE WHEN `Orig Interest Only Term` IS NOT NULL AND CAST(`Orig Interest Only Term` AS DOUBLE) > 0 THEN 1 ELSE 0 END AS `Curr Interest Only Flag`,\n\n    COALESCE(`Current Junior Mortgage Balance`, 0) / NULLIF(`Property Latest Value ($)`, 0) AS `Curr Jr LTV (Calc)`,\n\n    COALESCE(`Curr Loan Balance`, 0) / `Property Latest Value ($)` AS `Curr LTV`,\n\n    COALESCE(`Curr Loan Balance`, 0) / COALESCE(`Property Latest Value ($)`, 0) AS `Curr LTV (Calc)`,\n\n    `Orig Occupancy Status` AS `Curr Occupancy Status`,\n\n    -- next due date one month after paid-thru\n    add_months(to_date(`Curr Payment Paid Thru Date`), 1) AS `Curr Payment Next Due Date`,\n\n    COALESCE(`Senior Lien Current Balance`, 0) / NULLIF(`Property Latest Value ($)`, 0) AS `Curr Sr LTV (Calc)`,\n\n    COALESCE(`Borr 1 Credit Score`, `Borr 2 Credit Score`) AS `Current FICO`,\n\n    `Borr 1 Credit Score Date` AS `Current FICO Date`,\n\n    CASE WHEN lower(COALESCE(`MI Type`, '')) LIKE '%fha%' THEN 1 ELSE 0 END AS `FHA Flag`,\n\n    CASE WHEN lower(COALESCE(`Doc Type`, '')) LIKE '%f%ll%' THEN 1 ELSE 0 END AS `Full Doc Flag`,\n\n    -- Loan Age: floor(months_between(AsOfDate, OrigFirstPaymentDate)) + 1, not negative\n    GREATEST(0, CAST(FLOOR(months_between(to_date(`As Of Date`), to_date(`Orig First Payment Date`))) AS INT) + 1) AS `Loan Age`,\n\n    CASE WHEN `Orig Amortization Term` > `Orig Loan Term` THEN 1 ELSE 0 END AS `Orig Balloon Flag`,\n\n    CASE WHEN CAST(`Orig Interest Only Term` AS DOUBLE) > 0\n         THEN add_months(to_date(`Orig First Payment Date`), CAST(`Orig Interest Only Term` AS INT))\n         ELSE NULL END AS `Orig Interest Only Exp Date`,\n\n    CASE WHEN CAST(`Orig Interest Only Term` AS DOUBLE) > 0 THEN 1 ELSE 0 END AS `Orig Interest Only Flag`,\n\n    -- Orig Jr LTV: divide by the lesser of sales price / appraisal value (handle nulls)\n    COALESCE(`Orig Junior Loan Amount`, 0) /\n      CASE\n        WHEN `Orig Sales Price` IS NOT NULL AND `Orig Appraisal Value` IS NOT NULL\n          THEN CASE WHEN `Orig Sales Price` < `Orig Appraisal Value` THEN `Orig Sales Price` ELSE `Orig Appraisal Value` END\n        WHEN `Orig Sales Price` IS NOT NULL THEN `Orig Sales Price`\n        ELSE `Orig Appraisal Value`\n      END AS `Orig Jr LTV`,\n\n    COALESCE(`Orig Junior Loan Amount`, 0) /\n      NULLIF(\n        CASE\n          WHEN `Orig Sales Price` IS NOT NULL AND `Orig Appraisal Value` IS NOT NULL\n            THEN CASE WHEN `Orig Sales Price` < `Orig Appraisal Value` THEN `Orig Sales Price` ELSE `Orig Appraisal Value` END\n          WHEN `Orig Sales Price` IS NOT NULL THEN `Orig Sales Price`\n          ELSE `Orig Appraisal Value`\n        END, 0) AS `Orig Jr LTV (Calc)`,\n\n    COALESCE(`Orig Loan Amount`, 0) / NULLIF(\n      CASE\n        WHEN `Orig Sales Price` < `Orig Appraisal Value` OR `Orig Appraisal Value` IS NULL THEN `Orig Sales Price`\n        WHEN `Orig Appraisal Value` < `Orig Sales Price` OR `Orig Sales Price` IS NULL THEN `Orig Appraisal Value`\n        ELSE `Orig Sales Price`\n      END, 0) AS `Orig LTV (Calc)`,\n\n    CAST(FLOOR(months_between(to_date(`Curr Loan Maturity Date`), to_date(`Orig First Payment Date`))) AS INT) AS `Orig Loan Term (Calc to Curr Maturity)`,\n\n    CASE WHEN `Prepayment Penalty Period` > 0 THEN 1 ELSE 0 END AS `Orig Prepayment Penalty Flag`,\n\n    -- Pay History Current for 24: if string exists and removing all '0' leaves empty => 1 else 0 (else NULL)\n    CASE\n      WHEN LENGTH(CAST(`Pay History 24 Mths` AS STRING)) > 0\n        THEN CASE WHEN LENGTH(REPLACE(CAST(`Pay History 24 Mths` AS STRING), '0', '')) = 0 THEN 1 ELSE 0 END\n      ELSE NULL\n    END AS `Pay History Current for 24`,\n\n    CASE WHEN `Modification Flag` = 1 THEN `Curr Loan Maturity Date` ELSE NULL END AS `Post-Mod Maturity Date`,\n\n    -- Prepayment Penalty Exp Date\n    add_months(to_date(`Orig First Payment Date`), CAST(`Prepayment Penalty Period` AS INT)) AS `Prepayment Penalty Exp Date`,\n\n    CASE WHEN `ARM Flag` = 1 THEN 'ARM' ELSE 'Fixed' END AS `Rate Type`,\n\n    -- Remaining amortization NPER calc using ln; ensure numeric casts\n    (ln(1 - (COALESCE(`Curr Loan Balance`, 0) * (COALESCE(`Curr Loan Interest Rate`, 0) / 12.0) / NULLIF(`Curr PI Payment`, 0)))\n      / ln(1 + (COALESCE(`Curr Loan Interest Rate`, 0) / 12.0))) * -1 AS `Remaining Amortization Term (NPER Calc)`,\n\n    CAST(FLOOR(months_between(to_date(`Curr Loan Maturity Date`), to_date(`As Of Date`))) AS INT) AS `Remaining Loan Term (Calc to Curr Maturity)`,\n\n    `Orig Loan Amount` AS `Rvs Init Advance Amount`,\n\n    -- Seller Product Type: construct strings with concat\n    CASE\n      WHEN CAST(`ARM Initial Fixed Rate Period` AS DOUBLE) > 0\n        THEN concat('HY', CAST(ROUND(CAST(`ARM Initial Fixed Rate Period` AS DOUBLE) / 12.0, 0) AS INT), '/1')\n      ELSE concat(\n             CASE WHEN `Orig Amortization Type` = 1 THEN 'FIX' ELSE 'ARM' END,\n             CAST(COALESCE(ROUND(CAST(`Orig Loan Term` AS DOUBLE) / 60.0, 0) * 5, 30) AS INT)\n           )\n    END AS `Seller Product Type`,\n\n    CASE WHEN lower(COALESCE(`MI Type`, '')) LIKE '%usda%' THEN 1 ELSE 0 END AS `USDA Flag`,\n\n    CASE WHEN lower(COALESCE(`MI Type`, '')) LIKE '%va%' THEN 1 ELSE 0 END AS `VA Flag`\n\n  FROM CTE_Level_0\n),\n\nCTE_Level_2 AS (\n  SELECT\n    *,\n    -- ARM Remaining Fixed Rate Period: ((months_between(ARM First Rate Adj Date, Orig First Payment Date) floored)+1) - Loan Age, else 0\n    CASE\n      WHEN (CAST(FLOOR(months_between(to_date(`ARM First Rate Adj Date`), to_date(`Orig First Payment Date`))) AS INT) + 1) - `Loan Age` > 0\n        THEN (CAST(FLOOR(months_between(to_date(`ARM First Rate Adj Date`), to_date(`Orig First Payment Date`))) AS INT) + 1) - `Loan Age`\n      ELSE 0\n    END AS `ARM Remaining Fixed Rate Period`,\n\n    -- Days Delinquent: datediff(AsOfDate, CurrPaymentNextDueDate) + 30 if positive else 0 (approximation of original logic)\n    CASE\n      WHEN datediff(to_date(`As Of Date`), to_date(`Curr Payment Next Due Date`)) + 30 > 0\n        THEN datediff(to_date(`As Of Date`), to_date(`Curr Payment Next Due Date`)) + 30\n      ELSE 0\n    END AS `Days Delinquent`,\n\n    `Post-Mod Maturity Date` AS `Orig Loan Maturity Date`,\n\n    CAST(FLOOR(months_between(to_date(`Curr Payment Next Due Date`), to_date(`Curr Payment Paid Thru Date`))) AS INT) AS `Payment Frequency`,\n\n    `Orig Amortization Term` - `Loan Age` AS `Remaining Amortization Term`,\n\n    CASE WHEN (`Orig Interest Only Term` - `Loan Age`) > 0 THEN (`Orig Interest Only Term` - `Loan Age`) ELSE 0 END AS `Remaining Interest Only Term`,\n\n    `Orig Loan Term` - CASE WHEN `Loan Age` > 0 THEN `Loan Age` ELSE 0 END AS `Remaining Loan Term`,\n\n    CAST(FLOOR(months_between(to_date(`Prepayment Penalty Exp Date`), GREATEST(to_date(`As Of Date`), to_date(`Orig First Payment Date`)))) AS INT) AS `Remaining Prepayment Penalty Period`\n\n  FROM CTE_Level_1\n),\n\nCTE_Level_3 AS (\n  SELECT\n    *,\n    CASE WHEN `Remaining Amortization Term` > `Remaining Loan Term (Calc to Curr Maturity)` THEN 1 ELSE 0 END AS `Curr Balloon Flag`,\n    CAST(FLOOR(months_between(to_date(`Orig Loan Maturity Date`), to_date(`Orig First Payment Date`))) AS INT) AS `Orig Loan Term (Calc to Orig Maturity)`,\n    CAST(FLOOR(months_between(to_date(`Orig Loan Maturity Date`), to_date(`As Of Date`))) AS INT) AS `Remaining Loan Term (Calc to Orig Maturity)`\n  FROM CTE_Level_2\n)\n\nSELECT * FROM CTE_Level_3"
        } ]
      },
      "ports" : {
        "inputs" : [ {
          "id" : "AdHAQr6nnqjG1qXVunDvq$$Kcab0FWx5RKkb542aLR1W",
          "slug" : "gsmbs_raw_source"
        } ],
        "outputs" : [ {
          "id" : "0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR",
          "slug" : "out",
          "dataExplorerProps" : {
            "sorts" : [ {
              "exp" : {
                "type" : "Field",
                "value" : "Credit Line Usage Ratio"
              },
              "type" : "Simple",
              "order" : {
                "type" : "Desc"
              }
            } ],
            "filter" : {
              "type" : "Composite",
              "op" : {
                "type" : "AND"
              },
              "filters" : [ ]
            }
          }
        } ],
        "isCustomOutputSchema" : false,
        "autoUpdateOnRun" : false
      }
    },
    "C9HrNyURlM6qMO9vfysrG$$Er_aTu7xa0mv-9yhmEtYm" : {
      "id" : "C9HrNyURlM6qMO9vfysrG$$Er_aTu7xa0mv-9yhmEtYm",
      "component" : "Source",
      "metadata" : {
        "label" : "gsmbs_raw_source",
        "x" : -340,
        "y" : -200,
        "phase" : 0
      },
      "properties" : {
        "table" : {
          "name" : "gsmbs_raw_source",
          "sourceType" : "Table",
          "sourceName" : "waterfall_harmonizer_cdm",
          "alias" : ""
        }
      },
      "ports" : {
        "inputs" : [ ],
        "outputs" : [ {
          "id" : "NubOAHqL",
          "slug" : "out"
        } ],
        "isCustomOutputSchema" : false,
        "autoUpdateOnRun" : false
      }
    }
  },
  "connections" : [ {
    "id" : "conn_BHwkH_fHM8TOQw67WLFow$$a6-WJuctRaPS6Ugje5UvQ_0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR_sqlstatement_1_0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR",
    "source" : "BHwkH_fHM8TOQw67WLFow$$a6-WJuctRaPS6Ugje5UvQ",
    "sourcePort" : "0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR",
    "target" : "sqlstatement_1_0YVA6BOfziCILnVTa92qM$$uhYvZtr5SmXofIvoKUnPR",
    "targetPort" : "input_port_0"
  }, {
    "id" : "k5XFjLYDemuqHBtiV56sU",
    "source" : "C9HrNyURlM6qMO9vfysrG$$Er_aTu7xa0mv-9yhmEtYm",
    "sourcePort" : "NubOAHqL",
    "target" : "BHwkH_fHM8TOQw67WLFow$$a6-WJuctRaPS6Ugje5UvQ",
    "targetPort" : "AdHAQr6nnqjG1qXVunDvq$$Kcab0FWx5RKkb542aLR1W"
  } ],
  "component" : "Model"
}